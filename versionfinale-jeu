#include <stdio.h>
#include "biblio_fonction.h"
#include <conio.h>
#include <unistd.h>
#include <time.h>

extern char Tableau[LIGNE][COLONNE];
extern int NIV;
//coordonnées initiales
extern int Xi,Yi;
//compteur
int compteur_vie = 3;

struct Balle {
    int X,Y,vecX,vecY;
};

void score(int tempsrestant, int niv)
{
    int scoreduniveau;
    int scoretotal = 0;
    scoreduniveau = tempsrestant*100;
    printf("Le score du niveau %d est : %d", niv,scoreduniveau);
    scoretotal += scoreduniveau;
    printf("le score total est : %d", scoretotal);
}

void acquisition_touche(char monter,char gauche,char descendre,char droite,char casser,char pause)
{
    char touche;
    do {
        touche = _getch();
    } while (!(touche == monter || touche == gauche || touche == descendre || touche == droite || touche == casser ||touche == pause));
    //reponse à la touche
    if ( touche == monter)
    {
        printf("%d", mouvement(Xi - 1, Yi, Xi - 2, Yi));
    }
    else if ( touche == gauche)
    {
        printf("%d", mouvement(Xi, Yi - 1, Xi, Yi - 2));
    }
    else if ( touche == descendre)
    {
        printf("%d",mouvement(Xi + 1, Yi, Xi + 2, Yi));
    }
    else if ( touche == droite)
    {
        printf("%d", mouvement(Xi, Yi + 1, Xi, Yi + 2));
    }
    else if ( touche == casser)
    {
        if (Tableau[Xi-1][Yi] == BLOC_CASSABLE)
            Tableau[Xi-1][Yi] = VIDE ;
        if (Tableau[Xi+1][Yi] == BLOC_CASSABLE)
            Tableau[Xi+1][Yi] = VIDE;
        if (Tableau[Xi][Yi-1] == BLOC_CASSABLE)
            Tableau[Xi][Yi-1] = VIDE;
        if (Tableau[Xi][Yi+1] == BLOC_CASSABLE)
            Tableau[Xi][Yi+1] = VIDE;
        affichage_tableau();
    }
    else if ( touche == pause)
    {
        menu_pause(0,NIV);
    }
}

void jeu(int niv,int victoire,int partie)
{
    //touches
    char  monter ='z', gauche = 'q',descendre = 's', droite = 'd',casser = 'c',pause = 'P';
    //timeur
    int seconds = 120;
    int i = 0 , n = 0 ;
    //stockeur
    char stockeur = ' ';

   if (victoire == 0)
    {
        //intialisation map
        printf("%d", generation_map_test(niv,partie));
        struct Balle B;
        B.vecX=1; B.vecY=1;
        B.X=4; B.Y=1;
        clock_t temps_ecoule;
        clock_t start_time = clock();

        do {
            if (compteur_vie == 0)
            {
                jeu(0,-1,0);
            }
            //boucle d'acquisition
            if (_kbhit())
            {
                save_touche(2,1,monter,gauche,descendre,droite,casser,pause);
            }
            temps_ecoule = clock() - start_time;
            if ( temps_ecoule/1000 == i )
            {
                if ( i == n)
                {
                    if (B.X==LIGNE-2)
                        B.vecX=-1;
                    else if (B.Y==COLONNE-2)
                        B.vecY=-1;
                    else if (B.X==1)
                        B.vecX=1;
                    else if (B.Y==1)
                        B.vecY=1;
                    B.X += B.vecX;
                    B.Y += B.vecY;
                    Tableau[B.X-B.vecX][B.Y-B.vecY] = stockeur;
                    stockeur = Tableau[B.X][B.Y];
                    temps = seconds - (temps_ecoule / 1000);
                    if (stockeur == S)
                    {
                        compteur_vie--;
                        stockeur = ' ';
                        temps = 120;
                        seconds = (temps_ecoule/1000)+seconds;
                    }
                    Tableau[B.X][B.Y] = CODEBALLE;
                    n++;
                    affichage_tableau();
                    i++;
                }

                    printf(" \rTemps restant : %d", temps);
                    printf("\nVies restantes : %d",compteur_vie);
            }
            if(temps == 0)
            {
                compteur_vie--;
            }

        }while(1);
    }
    else
    {
        system("cls");
        if (victoire == 1) {
            printf("You win !!!\n");
            score(i, niv-1);
            sleep(5);
            niv++;
            if (niv == 4) {
                menu();
            }
            victoire = 0;
            jeu(niv,0,0);
        }
        else if (victoire == -1)
        {
            printf("You lose !!!\n");
            sleep(5);
            menu();
        }
    }
}

void menu_pause(int choix,int niv)
{
    system("cls");
    printf("MENU PAUSE \n"
           "1 : Continuer\n"
           "2 : Sauvegarder\n"
           "3 : Quitter\n");
    do
    {
        choix = _getch();
    }while (!(choix == '1' || choix == '2'||choix == '3'||choix == '4'));
    switch(choix)
    {
        case '1' :
        {
            jeu(niv,0,1);
            break;
        }
        case '2' :
        {
            sauvegarde(0);
            break;
        }
        case '3' :
        {
            videur();
            menu();
            break;
        }
    }
}
