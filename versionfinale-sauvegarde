#include <stdio.h>
#include <conio.h>
#include <unistd.h>
#include "biblio_fonction.h"

extern int NIV;

extern char Tableau[LIGNE][COLONNE];

int sauvegarde( int choix)
{
    if ( choix == 1 )
    {
        FILE *fichier=NULL;
        fichier = fopen("RAM.txt", "w");

        if(fichier==NULL){
            printf("Echec lors de l'ouverture.\n");
            return 1;
        }
        for (int i = 0; i<LIGNE; i++){
            for (int j=0; j<COLONNE; j++) {
                fprintf(fichier, " %c", Tableau[i][j]);
            }
            fprintf(fichier, "\n");
        }
        fclose(fichier);
        menu_pause(0,NIV);
    }
    else
    {
        char nom1[TAILLE+1],nom2[TAILLE+1],nom3[TAILLE+1];
        FILE *fichier=NULL;
        system("cls");
        /*FILE *fc;
        fc=fopen ("fichier.ext","r");
        if (fc==0) printf ("fichier vierge");
        fclose (fc);*/
        printf("Menu Sauvegarde\n"
               "1 : \n"
               "2 : \n"
               "3 : \n"
               "Choississez ou sauvegarder votre partie\n"
               "Pour retourner au menu pause, taper 4");
        do
        {
            choix = _getch();
        }while (!(choix == '1' || choix == '2'||choix == '3'||choix == '4'));
        switch(choix)
        {
            case 1 :
            {
                charge(1,0);
                fichier = fopen("save1.txt", "w");

                if(fichier==NULL){
                    printf("Echec lors de l'ouverture.\n");
                    break;
                }
                printf("Quel est le nom de votre sauvegarde ? \n");
                scanf("%c",&nom1[TAILLE]);
                fprintf(fichier, " %c\n", nom1[TAILLE]);
                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        fprintf(fichier, " %c", Tableau[i][j]);
                    }
                    fprintf(fichier, "\n");
                }
                fclose(fichier);
                break;
            }
            case 2 :
            {
                charge(1,0);
                fichier = fopen("save2.txt", "w");

                if(fichier==NULL){
                    printf("Echec lors de l'ouverture.\n");
                    break;
                }
                printf("Quel est le nom de votre sauvegarde ? \n");
                scanf("%c",&nom2[TAILLE]);
                fprintf(fichier, " %c\n", nom2[TAILLE]);
                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        fprintf(fichier, " %c", Tableau[i][j]);
                    }
                    fprintf(fichier, "\n");
                }
                fclose(fichier);
                break;
            }
            case 3 :
            {
                charge(1,0);
                fichier = fopen("save3.txt", "w");

                if(fichier==NULL){
                    printf("Echec lors de l'ouverture.\n");
                    break;
                }
                printf("Quel est le nom de votre sauvegarde ? \n");
                scanf("%c",&nom3[TAILLE]);
                fprintf(fichier, " %c\n", nom3[TAILLE]);
                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        fprintf(fichier, " %c", Tableau[i][j]);
                    }
                    fprintf(fichier, "\n");
                }
                fclose(fichier);
                break;
            }
            case 4 :
            {
                menu_pause(0,NIV);
                break;
            }
        }
        sauvegarde(0);
    }
}

int charge(int choix, int num_save)
{
    char nom1[TAILLE+1],nom2[TAILLE+1],nom3[TAILLE+1];
    if ( choix == 1)
    {
        FILE *fichier=NULL;
        fichier = fopen("RAM.txt", "r");
        for (int i = 0; i<LIGNE; i++){
            for (int j=0; j<COLONNE; j++) {
                fscanf(fichier, " %c", &Tableau[i][j]);
            }
        }
        fclose(fichier);
        return 0;
    }
    else
    {
        switch (num_save)
        {
            case 1 :
            {
                FILE *fichier=NULL;
                fichier = fopen("save1.txt", "r");

                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        fscanf(fichier, " %c", &Tableau[i][j]);
                    }
                }
                fclose(fichier);
                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        printf(" %c", Tableau[i][j]);
                    }
                    printf("\n");
                }
                break;
            }
            case 2 :
            {
                FILE *fichier=NULL;
                fichier = fopen("save2.txt", "r");

                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        fscanf(fichier, " %c", &Tableau[i][j]);
                    }
                }
                fclose(fichier);
                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        printf(" %c", Tableau[i][j]);
                    }
                    printf("\n");
                }
                break;
            }
            case 3 :
            {
                FILE *fichier=NULL;
                fichier = fopen("save3.txt", "r");

                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        fscanf(fichier, " %c", &Tableau[i][j]);
                    }
                }
                fclose(fichier);
                for (int i = 0; i<LIGNE; i++){
                    for (int j=0; j<COLONNE; j++) {
                        printf(" %c", Tableau[i][j]);
                    }
                    printf("\n");
                }
                break;
            }
        }
    }
    return 0;
}

void videur()
{
    FILE *fc;
    fc=fopen("RAM.txt","w");
    fclose(fc);
}

void save_touche(int choix,int jeu, char monter,char gauche, char descendre, char droite, char casser, char sauvegarder)
{
    switch(choix)
    {
        case 1 :
        {
            FILE *fichier=NULL;
            fichier = fopen("touche.txt", "w");

            if(fichier==NULL){
                printf("Echec lors de l'ouverture.\n");
            }
            fprintf(fichier, "%c %c %c %c %c %c",monter,gauche,descendre,droite,casser,sauvegarder);
            fclose(fichier);
            break;
        }
        case 2 :
        {
            FILE *fichier=NULL;
            fichier = fopen("touche.txt", "r");
            fscanf(fichier, "%c %c %c %c %c %c",&monter,&gauche,&descendre,&droite,&casser,&sauvegarder);
            fclose(fichier);
            switch ( jeu )
            {
                case 0 :
                    menu_touche(jeu,monter,gauche,descendre,droite,casser,sauvegarder);
                    break;
                case 1 :
                    acquisition_touche(monter,gauche,descendre,droite,casser,sauvegarder);
                    break;
            }
        }
    }
}
